<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Risultati Rally</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 30px; }
    #content { display: none; }
    table { border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px 10px; }
    th { background: #eee; }
    
    td.best-time {
    background: #c8f7c5;   /* verde chiaro molto visibile */
    font-weight: 700;
  }
  td.total-col {
    font-weight: 700;
  }
  </style>
</head>
<body>

<h2>Accesso risultati gara</h2>

<div id="login">
  <input type="password" id="password" placeholder="Password">
  <button onclick="login()">Accedi</button>
  <p id="error" style="color:red;"></p>
</div>

<div id="content">
  <h2>Tempi test</h2>
  <table id="results">
    <thead>
      <tr>
        <th>#</th>
        <th>Numero</th>
        <th>Equipaggio</th>
        <th>PS1</th>
        <th>PS2</th>
        <th>PS3</th>
        <th>PS4</th>
        <th>PS5</th>
        <th>Totale</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="loadResults()" style="margin-bottom: 10px;">
  ðŸ”„ Aggiorna risultati
  </button>
</div>

<script>
const PASSWORD = "rallytest2025"; // <-- cambia qui

function login() {
  const pw = document.getElementById("password").value;
  if (pw === PASSWORD) {
    document.getElementById("login").style.display = "none";
    document.getElementById("content").style.display = "block";
    loadResults();
  } else {
    document.getElementById("error").innerText = "Password errata";
  }
}

function timeToMs(t) {
  const s = (t ?? "").trim();
  if (!s) return null; // vuoto = non presente

  // atteso: mm:ss.mmm
  const parts = s.split(":");
  if (parts.length !== 2) return null;

  const m = Number(parts[0]);
  const secParts = parts[1].split(".");
  if (secParts.length !== 2) return null;

  const sec = Number(secParts[0]);
  const ms = Number(secParts[1]);

  if ([m, sec, ms].some(n => Number.isNaN(n))) return null;
  return m * 60000 + sec * 1000 + ms;
}


function msToTime(ms) {
  const m = Math.floor(ms / 60000);
  const s = Math.floor((ms % 60000) / 1000);
  const mm = ms % 1000;
  return `${m}:${String(s).padStart(2,'0')}.${String(mm).padStart(3,'0')}`;
}

async function loadResults() {
  const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT_iuC5NWc77IJvhRwJz9j-WS8k5s05SSGQ4u7caOd9yRNcqa1JNDzc-D4Witqbjsd_oAGqo_rgSp1H/pub?gid=0&single=true&output=csv";
  const res = await fetch(url);
  const text = await res.text();

  const lines = text.trim().split(/\r?\n/);
  const header = lines[0].split(",").map(h => h.trim().toLowerCase());
  const idx = (name) => header.indexOf(name);

  const iCar = idx("car");
  const iDriver = idx("driver");
  const iCodriver = idx("codriver");
  const iPs1 = idx("ps1");
  const iPs2 = idx("ps2");
  const iPs3 = idx("ps3");
  const iPs4 = idx("ps4");
  const iPs5 = idx("ps5");

  const rows = [];

  for (let k = 1; k < lines.length; k++) {
    const r = lines[k].trim();
    if (!r) continue;

    const cols = r.split(",");

    const car = (cols[iCar] ?? "").trim();
    if (!car) continue;

    const driver = (cols[iDriver] ?? "").trim();
    const codriver = (cols[iCodriver] ?? "").trim();

    const ps = [
      (cols[iPs1] ?? "").trim(),
      (cols[iPs2] ?? "").trim(),
      (cols[iPs3] ?? "").trim(),
      (cols[iPs4] ?? "").trim(),
      (cols[iPs5] ?? "").trim(),
    ];

    const psMs = ps.map(timeToMs);

    // quante PS completate?
    const completedCount = psMs.filter(v => v !== null).length;

    // totale = somma PS presenti
    const totalMs = psMs.reduce((acc, v) => acc + (v ?? 0), 0);

    // best = minimo tra PS presenti
    const bestMs = psMs.reduce((best, v) => {
      if (v === null) return best;
      return (best === null || v < best) ? v : best;
    }, null);

    const crew = codriver ? `${driver} / ${codriver}` : driver;

    rows.push({
      car,
      crew,
      ps,
      psMs,
      completedCount,
      totalMs,
      bestMs
    });
  }

  // ORDINAMENTO:
  // 1) piÃ¹ PS completate in alto
  // 2) a paritÃ , totale minore in alto
  // 3) tie-break: numero auto (se numerico) o stringa
  rows.sort((a, b) => {
    if (b.completedCount !== a.completedCount) return b.completedCount - a.completedCount;
    if (a.totalMs !== b.totalMs) return a.totalMs - b.totalMs;

    const an = Number(a.car), bn = Number(b.car);
    if (!Number.isNaN(an) && !Number.isNaN(bn)) return an - bn;
    return String(a.car).localeCompare(String(b.car));
  });

  const tbody = document.querySelector("#results tbody");
  tbody.innerHTML = "";

  rows.forEach((e, i) => {
    const totalText = e.completedCount > 0 ? msToTime(e.totalMs) : "";

    // prepara le celle PS con highlight sul best
    const psTds = e.ps.map((t, idxPs) => {
      const ms = e.psMs[idxPs];
      const isBest = (ms !== null && e.bestMs !== null && ms === e.bestMs);
      return `<td class="${isBest ? "best-time" : ""}">${t}</td>`;
    }).join("");

    tbody.innerHTML += `
      <tr>
        <td>${i + 1}</td>
        <td>${e.car}</td>
        <td>${e.crew}</td>
        ${psTds}
        <td class="total-col">${totalText}</td>
      </tr>`;
  });
}

</script>

</body>
</html>
